<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Message</title>
    
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Added 'Great Vibes' for the signature -->
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Outfit:wght@200;400;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #050505;
            --text-main: #ededed;
            --text-muted: #888;
            --accent: #e63946;
            --accent-glow: rgba(230, 57, 70, 0.5);
            --gold: #d4af37;
            --glass-bg: rgba(15, 15, 15, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 40px 80px rgba(0, 0, 0, 0.9);
            --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
            --ease-in-out: cubic-bezier(0.645, 0.045, 0.355, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg);
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1500px;
        }

        /* --- ATMOSPHERE --- */
        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 4;
        }

        /* --- CANVAS LAYERS --- */
        #fireworks-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0; 
            pointer-events: none;
        }

        #snow-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2; 
            pointer-events: none;
            opacity: 0.6; 
        }

        /* --- LAYERS --- */
        .layer {
            position: absolute;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1.2s var(--ease-in-out), transform 1.2s var(--ease-in-out);
            z-index: 10;
        }
        .hidden { opacity: 0; pointer-events: none; transform: scale(1.05); }

        /* --- 0. PASSWORD SCREEN --- */
        .pass-wrapper { 
            text-align: center; 
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .pass-label {
            font-family: 'Outfit', sans-serif;
            font-weight: 200;
            font-size: 0.9rem;
            margin-bottom: 30px;
            letter-spacing: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        input[type="password"] {
            background: transparent;
            border: none;
            border-bottom: 1px solid #333;
            color: #fff;
            font-family: 'Outfit', sans-serif;
            font-size: 2.5rem;
            text-align: center;
            padding: 15px;
            outline: none;
            width: 320px;
            letter-spacing: 12px;
            transition: 0.4s var(--ease-out);
            border-radius: 0;
        }
        input[type="password"]::placeholder {
            color: #333;
            letter-spacing: 2px;
            font-size: 2rem;
        }
        input[type="password"]:focus {
            border-bottom-color: var(--accent);
            text-shadow: 0 0 15px var(--accent-glow);
        }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; border-bottom-color: var(--accent) !important; color: var(--accent); }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* --- 1. START SCREEN --- */
        .start-btn {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(10px);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.15);
            padding: 24px 80px;
            font-size: 0.9rem;
            letter-spacing: 6px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.6s var(--ease-out);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        .start-btn:hover {
            background: rgba(255,255,255,0.08);
            border-color: var(--accent);
            box-shadow: 0 0 30px var(--accent-glow);
            letter-spacing: 8px;
        }

        /* --- 2. LOADER --- */
        .loader-wrapper { width: 300px; text-align: center; }
        .loader-text {
            font-family: 'Outfit', sans-serif;
            font-weight: 200;
            font-size: 1rem;
            letter-spacing: 3px;
            margin-bottom: 25px;
            color: #888;
        }
        .progress-track { 
            width: 100%; height: 2px; 
            background: #222; 
            position: relative; 
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%; width: 0%; 
            background: var(--accent);
            box-shadow: 0 0 20px var(--accent);
            transition: width 0.3s ease-out;
            position: relative;
        }
        .progress-fill::after {
            content: ''; position: absolute; top:0; right:0; bottom:0; width: 10px;
            background: #fff;
            box-shadow: 0 0 15px #fff;
            opacity: 0.7;
        }

        /* --- 3. THE 3D ENVELOPE --- */
        .envelope-wrapper {
            position: relative;
            width: 350px;
            height: 240px;
            cursor: pointer;
            transform-style: preserve-3d;
        }

        .envelope-body {
            position: absolute;
            bottom: 0; width: 100%; height: 100%;
            background: #1a1a1a;
            background: linear-gradient(135deg, #222 0%, #151515 100%);
            border: 1px solid #333;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            border-radius: 3px;
        }

        .envelope-flap {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 120px;
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 1px solid #333;
            border-bottom: none;
            clip-path: polygon(0 0, 50% 100%, 100% 0);
            transform-origin: top;
            transition: transform 1.4s var(--ease-in-out);
            z-index: 20;
        }
        
        .envelope-flap::after {
            content: '';
            position: absolute;
            top: 75px; left: 50%;
            transform: translateX(-50%);
            width: 32px; height: 32px;
            background: radial-gradient(circle at 30% 30%, #ff4d4d, #8a0000);
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .envelope-pocket {
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 100%;
            z-index: 15;
            background: linear-gradient(180deg, rgba(255,255,255,0) 30%, rgba(20,20,20,0.9) 100%);
            clip-path: polygon(0 0, 50% 40%, 100% 0, 100% 100%, 0 100%);
            pointer-events: none;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .envelope-card-preview {
            position: absolute;
            bottom: 10px; left: 20px; right: 20px; height: 200px;
            background: #fdfdfd;
            z-index: 5;
            transition: transform 1.6s var(--ease-in-out);
            border-radius: 2px;
            background-image: linear-gradient(#eee 1px, transparent 1px);
            background-size: 100% 2rem;
        }

        .stamp {
            z-index: 30;
            position: absolute;
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            font-family: 'Playfair Display', serif;
            color: rgba(255,255,255,0.4);
            font-size: 1.4rem;
            letter-spacing: 2px;
            pointer-events: none;
            width: 100%;
            text-align: center;
        }

        .envelope-open .envelope-flap { transform: rotateX(180deg); z-index: 1; }
        .envelope-open .envelope-card-preview { transform: translateY(-180px); transition-delay: 0.3s; }

        .hint {
            position: absolute;
            bottom: -80px;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            letter-spacing: 4px;
            color: #666;
            text-transform: uppercase;
            transition: opacity 0.5s ease;
        }

        /* --- 4. TEXT SEQUENCE --- */
        .seq-text {
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem;
            text-align: center;
            line-height: 1.3;
            max-width: 900px;
            opacity: 0;
            filter: blur(12px);
            transform: scale(0.95);
            transition: all 1.5s var(--ease-out);
            color: #f0f0f0;
            padding: 0 20px;
            text-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .seq-visible { opacity: 1; filter: blur(0); transform: scale(1); }

        /* --- 5. FINAL CARD --- */
        .card-container {
            width: 90%;
            max-width: 650px;
            height: auto;
            max-height: 80vh;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 60px 50px 80px 50px;
            text-align: left;
            position: relative;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            opacity: 0; 
            transform: translateY(30px);
            transition: opacity 2.5s ease-in-out, transform 2.5s ease-in-out;
        }
        
        .card-container.active { opacity: 1; transform: translateY(0); }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            color: #fff;
            text-align: center;
            margin: 0 0 50px 0;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: 1.2s var(--ease-out) 0.5s;
            text-shadow: 0 0 40px rgba(230, 57, 70, 0.3);
        }

        .text-block {
            font-size: 1.2rem;
            line-height: 1.8;
            color: #d6d6d6;
            margin-bottom: 30px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 1.2s var(--ease-out);
            font-weight: 300;
        }

        .highlight { 
            color: #fff; 
            font-weight: 500;
            border-bottom: 1px solid var(--accent); 
        }

        .signature {
            /* Fancy Large Cursive Font */
            font-family: 'Great Vibes', cursive;
            font-size: 4rem;
            text-align: right;
            margin-top: 50px;
            color: var(--accent);
            opacity: 0;
            transition: 1.2s var(--ease-out) 2s;
            text-shadow: 0 0 10px rgba(230, 57, 70, 0.3);
        }

        .reveal { opacity: 1 !important; transform: translateY(0) !important; }

        .scroll-indicator {
            position: absolute;
            bottom: 20px; left: 0; width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.4);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            pointer-events: none;
            transition: opacity 0.5s ease;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            animation: bounce 2s infinite;
        }
        .scroll-arrow {
            width: 10px; height: 10px;
            border-right: 1px solid rgba(255,255,255,0.4);
            border-bottom: 1px solid rgba(255,255,255,0.4);
            transform: rotate(45deg);
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-5px);}
            60% {transform: translateY(-3px);}
        }

        @media (max-width: 600px) {
            .seq-text { font-size: 2rem; }
            h1 { font-size: 2.5rem; }
            .text-block { font-size: 1.05rem; }
            .card-container { padding: 40px 30px 70px 30px; max-height: 75vh; }
            input[type="password"] { width: 260px; font-size: 2rem; }
            .signature { font-size: 3rem; }
        }
    </style>
</head>
<body>

    <!-- CANVASES -->
    <canvas id="fireworks-canvas"></canvas>
    <canvas id="snow-canvas"></canvas>

    <!-- 0. PASSWORD -->
    <div id="l-password" class="layer">
        <div class="pass-wrapper">
            <div class="pass-label">Enter Password</div>
            <input type="password" id="pass-input" placeholder="â€¢â€¢â€¢â€¢" autocomplete="off">
        </div>
    </div>

    <!-- 1. START -->
    <div id="l-start" class="layer hidden">
        <button class="start-btn" id="start-btn">Open File</button>
    </div>

    <!-- 2. LOADER -->
    <div id="l-loader" class="layer hidden">
        <div class="loader-wrapper">
            <div class="loader-text" id="load-text">Decrypting... 0%</div>
            <div class="progress-track">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- 3. ENVELOPE -->
    <div id="l-envelope" class="layer hidden">
        <div class="envelope-wrapper" id="envelope-wrapper">
            <div class="envelope-flap"></div>
            <div class="envelope-card-preview"></div>
            <div class="envelope-body">
                <div class="stamp">For Aubrey</div>
            </div>
            <div class="envelope-pocket"></div>
        </div>
        <div class="hint" id="hint-text">Catch it...</div>
    </div>

    <!-- 4. SEQUENCE -->
    <div id="l-sequence" class="layer hidden">
        <div class="seq-text" id="seq-content"></div>
    </div>

    <!-- 5. FINAL CARD -->
    <div id="l-card" class="layer hidden">
        <div class="card-container">
            <h1 id="final-header">Merry Christmas ðŸŽ„</h1>
            
            <p class="text-block">I wanted to take a second to write this just to say how much I appreciate having you around. Honestly, getting to know you has been a <span class="highlight">huge highlight</span> of my year.</p>

            <p class="text-block">You just have a way of making everything way less boring. Whether weâ€™re joking around or just talking about random stuff, itâ€™s honestly become my favorite part of the day.</p>

            <p class="text-block">Youâ€™re genuinely one of the <span class="highlight">coolest people I know</span>, and the world definitely needs more people like you.</p>

            <p class="text-block">I hope you have an amazing break, eat good food, and finally get some time to just relax and recharge. You definitely deserve it.</p>

            <div class="signature">- Thomas</div>

            <!-- Scroll Indicator -->
            <div class="scroll-indicator" id="scroll-hint">
                <span>Scroll</span>
                <div class="scroll-arrow"></div>
            </div>
        </div>
    </div>

    <script>
        /* ----------------------------------------------------
           1. CINEMATIC FIREWORKS ENGINE
           ---------------------------------------------------- */
        const fCanvas = document.getElementById('fireworks-canvas');
        const fCtx = fCanvas.getContext('2d');
        let fWidth, fHeight;
        
        let shells = [];
        let sparks = [];

        function resizeFireworks() {
            fWidth = fCanvas.width = window.innerWidth;
            fHeight = fCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeFireworks);
        resizeFireworks();

        // Helper
        const random = (min, max) => Math.random() * (max - min) + min;

        // The Rocket rising
        class Shell {
            constructor() {
                this.x = random(fWidth * 0.2, fWidth * 0.8);
                this.y = fHeight;
                this.targetY = random(fHeight * 0.1, fHeight * 0.4); // Aim high
                this.speed = random(8, 13);
                this.angle = random(-Math.PI / 12, Math.PI / 12) + Math.PI / 2; // Slight spread
                this.vx = Math.cos(this.angle) * 1.5; // Slight drift
                this.vy = -this.speed;
                
                // Color for the trail
                this.hue = Math.floor(random(0, 360));
                this.trail = []; 
                this.exploded = false;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                
                // Gravity on the shell itself
                this.vy += 0.15;

                // Trail history
                this.trail.push({x: this.x, y: this.y});
                if(this.trail.length > 10) this.trail.shift();

                // Explode when slow enough or reached target
                if (this.vy > -1 || this.y < this.targetY) {
                    this.exploded = true;
                    explode(this.x, this.y, this.hue);
                }
            }

            draw() {
                fCtx.beginPath();
                for(let i=0; i<this.trail.length; i++) {
                    const point = this.trail[i];
                    fCtx.lineTo(point.x, point.y);
                }
                fCtx.strokeStyle = `hsla(${this.hue}, 100%, 70%, 1)`;
                fCtx.lineWidth = 2;
                fCtx.stroke();
            }
        }

        // The Particles after explosion
        class Spark {
            constructor(x, y, hue, type) {
                this.x = x; this.y = y;
                this.type = type; // 'classic', 'willow', 'ring'
                
                const angle = random(0, Math.PI * 2);
                let speed = random(1, 6);
                
                // Physics tweaks based on type
                this.friction = 0.96;
                this.gravity = 0.08;
                this.decay = random(0.01, 0.025);
                this.brightness = random(60, 90);
                this.hue = hue + random(-20, 20);

                if (type === 'willow') {
                    speed = random(1, 9);
                    this.friction = 0.92; // Stops outward fast
                    this.gravity = 0.15;  // Falls down fast
                    this.decay = random(0.005, 0.015); // Long life
                    this.hue = 45; // Gold
                } else if (type === 'ring') {
                    speed = 4; // Constant speed
                    this.friction = 0.98;
                    this.decay = 0.02;
                }

                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                
                this.alpha = 1;
                this.coordinates = [];
                this.coordinateCount = (type === 'willow') ? 10 : 5;
                while(this.coordinateCount--) this.coordinates.push([this.x, this.y]);
            }

            update() {
                this.coordinates.pop();
                this.coordinates.unshift([this.x, this.y]);
                
                this.vx *= this.friction;
                this.vy *= this.friction;
                this.vy += this.gravity;
                
                this.x += this.vx;
                this.y += this.vy;
                this.alpha -= this.decay;
            }

            draw() {
                fCtx.beginPath();
                fCtx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
                fCtx.lineTo(this.x, this.y);
                fCtx.strokeStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`;
                fCtx.lineWidth = (this.type === 'willow') ? 1 : 2;
                fCtx.stroke();
            }
        }

        function explode(x, y, hue) {
            // Pick a type
            const rand = Math.random();
            let type = 'classic';
            let count = 60;
            if (rand < 0.3) { type = 'willow'; count = 80; }
            else if (rand < 0.5) { type = 'ring'; count = 50; }

            for(let i=0; i<count; i++) {
                sparks.push(new Spark(x, y, hue, type));
            }
        }

        function animateFireworks() {
            // Trail effect (clear with opacity)
            fCtx.globalCompositeOperation = 'destination-out';
            fCtx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
            fCtx.fillRect(0, 0, fWidth, fHeight);
            
            // Draw phase
            fCtx.globalCompositeOperation = 'lighter'; // Additive blending for glow

            // Draw Shells
            for(let i = shells.length - 1; i >= 0; i--) {
                shells[i].update();
                shells[i].draw();
                if(shells[i].exploded) shells.splice(i, 1);
            }

            // Draw Sparks
            for(let i = sparks.length - 1; i >= 0; i--) {
                sparks[i].update();
                sparks[i].draw();
                if(sparks[i].alpha <= 0) sparks.splice(i, 1);
            }

            // Launch Logic (Random frequency)
            if (Math.random() < 0.02) { 
                shells.push(new Shell());
            }

            requestAnimationFrame(animateFireworks);
        }
        animateFireworks();


        /* ----------------------------------------------------
           2. SNOW LOGIC
           ---------------------------------------------------- */
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let snowParticles = [];
        let mouse = { x: -9999, y: -9999 };
        
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
        function resizeSnow() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeSnow);
        resizeSnow();

        class SnowParticle {
            constructor() { this.reset(true); }
            reset(initial = false) {
                this.x = Math.random() * width;
                this.y = initial ? Math.random() * height : -10;
                this.vx = (Math.random() - 0.5) * 0.5; 
                this.vy = Math.random() * 1 + 0.5;
                this.size = Math.random() * 2 + 1;
                this.alpha = Math.random() * 0.5 + 0.2;
            }
            update() {
                const dx = mouse.x - this.x;
                const dy = mouse.y - this.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 100) {
                    const angle = Math.atan2(dy, dx);
                    this.x -= Math.cos(angle) * 3;
                    this.y -= Math.sin(angle) * 3;
                }
                this.x += this.vx;
                this.y += this.vy;
                if(this.y > height) this.reset();
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                ctx.fill();
            }
        }

        for(let i=0; i<100; i++) snowParticles.push(new SnowParticle());
        function animateSnow() {
            ctx.clearRect(0,0,width,height);
            snowParticles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateSnow);
        }
        animateSnow();


        /* ----------------------------------------------------
           3. APP LOGIC
           ---------------------------------------------------- */

        const layers = {
            pass: document.getElementById('l-password'),
            start: document.getElementById('l-start'),
            loader: document.getElementById('l-loader'),
            envelope: document.getElementById('l-envelope'),
            sequence: document.getElementById('l-sequence'),
            card: document.getElementById('l-card')
        };

        // 0. PASSWORD
        const passInput = document.getElementById('pass-input');
        passInput.focus();
        
        passInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') checkPass();
        });

        function checkPass() {
            if(passInput.value.toLowerCase().trim() === 'christmas') {
                passInput.blur();
                layers.pass.classList.add('hidden');
                layers.start.classList.remove('hidden');
            } else {
                passInput.classList.add('shake');
                setTimeout(() => passInput.classList.remove('shake'), 500);
            }
        }

        // 1. START
        document.getElementById('start-btn').addEventListener('click', () => {
            layers.start.classList.add('hidden');
            layers.loader.classList.remove('hidden');
            runLoader();
        });

        // 2. LOADER
        function runLoader() {
            let p = 0;
            const text = document.getElementById('load-text');
            const fill = document.getElementById('progress-fill');

            function step() {
                const inc = Math.random() * 2 + 1.5; 
                p += inc;
                if (p > 100) p = 100;

                text.innerText = `Decrypting... ${Math.floor(p)}%`;
                fill.style.width = `${p}%`;

                if(p < 100) {
                    let delay = 20;
                    if(p > 60) delay = 50; 
                    setTimeout(step, delay);
                } else {
                    text.innerText = "Access Granted.";
                    text.style.color = "#fff";
                    setTimeout(() => {
                        layers.loader.classList.add('hidden');
                        layers.envelope.classList.remove('hidden');
                        initPhysics();
                    }, 800);
                }
            }
            step();
        }

        // 3. PHYSICS ENVELOPE
        const wrapper = document.getElementById('envelope-wrapper');
        let physicsActive = true;
        let pos = { x: 0, y: 0 };
        let target = { x: 0, y: 0 };
        let isOpening = false;

        function initPhysics() {
            setTimeout(() => {
                physicsActive = false;
                document.getElementById('hint-text').innerText = "Okay, open it.";
                target.x = 0; target.y = 0;
            }, 5000);

            function loop() {
                if (!physicsActive) {
                    pos.x += (0 - pos.x) * 0.1;
                    pos.y += (0 - pos.y) * 0.1;
                    wrapper.style.transform = `translate(${pos.x}px, ${pos.y}px)`;
                    if(Math.abs(pos.x) > 0.1) requestAnimationFrame(loop);
                    return;
                }
                pos.x += (target.x - pos.x) * 0.15;
                pos.y += (target.y - pos.y) * 0.15;
                wrapper.style.transform = `translate(${pos.x}px, ${pos.y}px) rotate(${pos.x * 0.05}deg)`;
                requestAnimationFrame(loop);
            }
            loop();

            document.addEventListener('mousemove', (e) => {
                if (!physicsActive) return;
                const rect = wrapper.getBoundingClientRect();
                const cx = rect.left + rect.width/2;
                const cy = rect.top + rect.height/2;
                const dx = e.clientX - cx;
                const dy = e.clientY - cy;
                const dist = Math.sqrt(dx*dx + dy*dy);

                if (dist < 350) {
                    const angle = Math.atan2(dy, dx);
                    target.x = -Math.cos(angle) * 250; 
                    target.y = -Math.sin(angle) * 250;
                } else {
                    target.x = 0; target.y = 0;
                }
            });
        }

        wrapper.addEventListener('click', () => {
            if(physicsActive) return;
            if(isOpening) return;
            isOpening = true;
            
            wrapper.classList.add('envelope-open');
            confetti({ 
                particleCount: 150, 
                spread: 100, 
                origin: { y: 0.6 },
                colors: ['#ffffff', '#ff4d4d', '#d4af37'],
                disableForReducedMotion: true
            });

            setTimeout(() => {
                layers.envelope.classList.add('hidden');
                layers.sequence.classList.remove('hidden');
                runSequence();
            }, 2200); 
        });

        // 4. SEQUENCE
        const lines = [
            "To the person who makes time disappear...",
            "The only person I never want to hang up on...",
            "To the girl I could talk to for eternity..."
        ];
        const seqEl = document.getElementById('seq-content');

        function runSequence() {
            let i = 0;
            function showLine() {
                if(i >= lines.length) {
                    layers.sequence.classList.add('hidden');
                    // Longer transition before showing card
                    setTimeout(showFinalCard, 1000); 
                    return;
                }
                seqEl.innerText = lines[i];
                seqEl.classList.add('seq-visible');
                
                // Duration Logic
                let duration = 3800;
                if (i === lines.length - 1) {
                    duration = 5000; // Wait 5 seconds on "Eternity"
                }
                
                setTimeout(() => {
                    seqEl.classList.remove('seq-visible');
                    setTimeout(() => {
                        i++;
                        showLine();
                    }, 1000); 
                }, duration);
            }
            showLine();
        }

        // 5. FINAL REVEAL
        function showFinalCard() {
            layers.card.classList.remove('hidden');
            const container = document.querySelector('.card-container');
            container.classList.add('active');
            
            setTimeout(() => { document.getElementById('final-header').classList.add('reveal'); }, 1000);

            const paras = document.querySelectorAll('.text-block');
            paras.forEach((p, index) => {
                setTimeout(() => { p.classList.add('reveal'); }, 2000 + (index * 800));
            });

            setTimeout(() => {
                document.querySelector('.signature').classList.add('reveal');
                confetti({ particleCount: 250, spread: 150, origin: { y: 0.7 }, colors: ['#ff4d4d', '#ffffff', '#d4af37'] });
            }, 5500);

            const hint = document.getElementById('scroll-hint');
            container.addEventListener('scroll', () => {
                if(container.scrollTop > 50) {
                    hint.style.opacity = '0';
                }
            });
        }

    </script>
</body>
</html>